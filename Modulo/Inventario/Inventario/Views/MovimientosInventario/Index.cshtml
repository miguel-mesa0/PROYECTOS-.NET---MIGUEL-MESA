@using Inventario.Models.Inventario
@model IEnumerable<Inventario.Models.Inventario.MovimientosInventario>

@{
    ViewData["Title"] = "Kardex de inventario";

    var repuestos = ViewBag.Repuestos as List<Repuesto>;
    var bodegas = ViewBag.Bodegas as List<Bodega>;

    int? repuestoIdSel = ViewBag.RepuestoIdSel != null ? (int?)ViewBag.RepuestoIdSel : null;
    int? bodegaIdSel = ViewBag.BodegaIdSel != null ? (int?)ViewBag.BodegaIdSel : null;
    DateTime? desde = ViewBag.Desde != null ? (DateTime?)ViewBag.Desde : null;
    DateTime? hasta = ViewBag.Hasta != null ? (DateTime?)ViewBag.Hasta : null;

    int saldoInicial = 0;
    if (ViewBag.SaldoInicial != null)
    {
        saldoInicial = (int)ViewBag.SaldoInicial;
    }

    string nombreRepuesto = repuestos?.FirstOrDefault(r => r.Id == repuestoIdSel)?.Nombre ?? "Todos";
    string nombreBodega = bodegas?.FirstOrDefault(b => b.Id == bodegaIdSel)?.Nombre ?? "Todas";
}

<div class="space-y-6">
    <!-- Encabezado -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">Kardex de inventario</h1>
            <p class="text-sm text-slate-500">
                Movimientos de stock por repuesto, bodega y rango de fechas.
            </p>
        </div>
    </div>

    <!-- Filtros -->
    <div class="bg-white rounded-xl shadow p-4 md:p-5">
        <form asp-action="Index" method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <!-- Repuesto -->
            <div>
                <label class="block text-xs font-semibold text-slate-600 mb-1">Repuesto</label>
                <select name="repuestoId"
                        class="w-full text-xs px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="">-- Todos --</option>
                    @if (repuestos != null)
                    {
                        foreach (var r in repuestos)
                        {
                            <option value="@r.Id"
                                    selected="@(repuestoIdSel.HasValue && repuestoIdSel.Value == r.Id)">
                                @r.Codigo - @r.Nombre
                            </option>
                        }
                    }
                </select>
            </div>

            <!-- Bodega -->
            <div>
                <label class="block text-xs font-semibold text-slate-600 mb-1">Bodega</label>
                <select name="bodegaId"
                        class="w-full text-xs px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="">-- Todas --</option>
                    @if (bodegas != null)
                    {
                        foreach (var b in bodegas)
                        {
                            <option value="@b.Id"
                                    selected="@(bodegaIdSel.HasValue && bodegaIdSel.Value == b.Id)">
                                @b.Nombre
                            </option>
                        }
                    }
                </select>
            </div>

            <!-- Desde -->
            <div>
                <label class="block text-xs font-semibold text-slate-600 mb-1">Desde</label>
                <input type="date"
                       name="desde"
                       value="@(desde?.ToString("yyyy-MM-dd"))"
                       class="w-full text-xs px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-emerald-500" />
            </div>

            <!-- Hasta + botón -->
            <div class="flex flex-col md:flex-row md:items-end gap-2">
                <div class="flex-1">
                    <label class="block text-xs font-semibold text-slate-600 mb-1">Hasta</label>
                    <input type="date"
                           name="hasta"
                           value="@(hasta?.ToString("yyyy-MM-dd"))"
                           class="w-full text-xs px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-emerald-500" />
                </div>
                <div class="pt-1 md:pt-0">
                    <button type="submit"
                            class="w-full md:w-auto mt-4 md:mt-0 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-semibold rounded-lg shadow">
                        Aplicar filtros
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Resumen -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
        <div class="bg-white rounded-xl shadow p-4">
            <p class="text-xs uppercase text-slate-500 font-semibold">Repuesto</p>
            <p class="text-slate-800 font-semibold">@nombreRepuesto</p>
        </div>
        <div class="bg-white rounded-xl shadow p-4">
            <p class="text-xs uppercase text-slate-500 font-semibold">Bodega</p>
            <p class="text-slate-800 font-semibold">@nombreBodega</p>
        </div>
        <div class="bg-white rounded-xl shadow p-4">
            <p class="text-xs uppercase text-slate-500 font-semibold">Stock inicial</p>
            <p class="text-slate-800 font-semibold">@saldoInicial</p>
        </div>
    </div>

    <!-- Tabla Kardex -->
    <div class="bg-white rounded-xl shadow overflow-hidden">
        <div class="px-4 py-3 border-b bg-slate-50 flex justify-between items-center">
            <h2 class="text-sm font-bold text-slate-700 uppercase">Movimientos</h2>
            <p class="text-[11px] text-slate-500">
                Entradas, salidas y saldo acumulado.
            </p>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-xs md:text-sm">
                <thead class="bg-slate-100 border-b border-slate-200">
                    <tr>
                        <th class="px-3 py-2 text-left font-semibold text-slate-600 uppercase">Fecha</th>
                        <th class="px-3 py-2 text-left font-semibold text-slate-600 uppercase">Documento</th>
                        <th class="px-3 py-2 text-left font-semibold text-slate-600 uppercase">Tipo</th>
                        <th class="px-3 py-2 text-right font-semibold text-emerald-700 uppercase">Entrada</th>
                        <th class="px-3 py-2 text-right font-semibold text-red-600 uppercase">Salida</th>
                        <th class="px-3 py-2 text-right font-semibold text-slate-700 uppercase">Saldo</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model == null || !Model.Any())
                    {
                        <tr>
                            <td colspan="6" class="px-4 py-6 text-center text-slate-400">
                                No hay movimientos para los filtros seleccionados.
                            </td>
                        </tr>
                    }
                    else
                    {
                        var saldo = saldoInicial;

                        foreach (var m in Model.OrderBy(x => x.Fecha).ThenBy(x => x.Id))
                        {
                            int entrada = m.Cantidad > 0 ? m.Cantidad : 0;
                            int salida = m.Cantidad < 0 ? -m.Cantidad : 0;
                            saldo += m.Cantidad;

                            string tipoDoc = m.TipoDocumento switch
                            {
                                1 => "Compra",
                                2 => "Venta",
                                3 => "Ajuste",
                                _ => "Otro"
                            };

                            <tr class="border-b border-slate-100 hover:bg-slate-50">
                                <td class="px-3 py-2 align-middle text-slate-700">
                                    @m.Fecha.ToString("dd/MM/yyyy HH:mm")
                                </td>
                                <td class="px-3 py-2 align-middle text-slate-700">
                                    @tipoDoc-@m.DocumentoId
                                </td>
                                <td class="px-3 py-2 align-middle text-slate-600">
                                    @tipoDoc
                                </td>
                                <td class="px-3 py-2 align-middle text-right text-emerald-700 font-semibold">
                                    @(entrada == 0 ? "" : entrada.ToString())
                                </td>
                                <td class="px-3 py-2 align-middle text-right text-red-600 font-semibold">
                                    @(salida == 0 ? "" : salida.ToString())
                                </td>
                                <td class="px-3 py-2 align-middle text-right font-bold text-slate-800">
                                    @saldo
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
